<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Sales & PAR Stock System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'nage-dark': '#0a0a0a',
              'nage-gray': '#1a1a1a',
              'nage-purple': '#667eea',
              'purple-dark': '#764ba2',
              'nage-gold': '#ffd700',
            },
          },
        },
      };
    </script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Keep only essential CSS */
        .section {
            display: none;
        }

        .section.active {
            display: block !important;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        /* Button styles for old .btn class */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Upload area border */
        .upload-area-border {
            border: 3px dashed #667eea;
        }

        .upload-area-border:hover {
            border-color: #764ba2;
        }

        /* Date selector */
        .date-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-selector label {
            color: #667eea;
            font-weight: bold;
        }

        .date-selector input,
        .date-selector select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
            font-size: 14px;
        }

        /* Conversion table */
        .conversion-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .conversion-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .conversion-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .conversion-table tr:hover {
            background-color: #f8f9ff;
        }

        .conversion-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #667eea;
            font-size: 14px;
            width: 200px;
        }

        /* Spinner animation */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message styles */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #dc2626;
        }

        /* Table styles */
        .conversion-table, .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        .conversion-table th, .summary-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .summary-table th {
            background: #dc2626;
        }

        .conversion-table td, .summary-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .conversion-table tr:hover {
            background-color: #f8f9ff;
        }

        .summary-table tr:hover {
            background-color: #fef2f2;
        }

        .conversion-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #667eea;
            font-size: 14px;
            width: 200px;
        }

        /* Status colors */
        .status-ok { color: #059669; font-weight: bold; }
        .status-warning { color: #f59e0b; font-weight: bold; }
        .status-critical { color: #dc2626; font-weight: bold; }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .progress-fill.critical {
            background: linear-gradient(90deg, #dc2626 0%, #991b1b 100%);
        }

        input[type="file"] {
            display: none;
        }

        .glow-effect {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        /* Scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-nage-purple via-purple-dark to-nage-purple min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="flex justify-between items-center text-white mb-8 flex-wrap gap-4">
            <div class="text-center flex-grow">
                <h1 class="text-4xl md:text-5xl font-bold mb-2 drop-shadow-lg">
                    <i class="fas fa-hotel mr-3"></i>Hotel Sales & PAR Stock System
                </h1>
                <p class="text-lg text-purple-100">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°</p>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm bg-white/20 px-4 py-2 rounded-full">
                    <i class="fas fa-user mr-2"></i><span id="currentUser">User</span>
                </span>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full font-semibold transition-all duration-300 hover:shadow-lg">
                    <i class="fas fa-sign-out-alt mr-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap justify-center gap-2 mb-8">
            <button class="tab px-4 py-2.5 text-sm md:text-base md:px-6 md:py-3 rounded-full font-semibold transition-all duration-300 bg-white text-nage-purple shadow-lg hover:shadow-xl hover:scale-105 active" onclick="switchTab('dailySale')">
                <i class="fas fa-file-upload mr-1 md:mr-2"></i><span class="whitespace-nowrap">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
            </button>
            <button class="tab px-4 py-2.5 text-sm md:text-base md:px-6 md:py-3 rounded-full font-semibold transition-all duration-300 bg-white/20 text-white hover:bg-white/30" onclick="switchTab('dailyTransfer')">
                <i class="fas fa-exchange-alt mr-1 md:mr-2"></i><span class="whitespace-nowrap">Transfer</span>
            </button>
            <button class="tab px-4 py-2.5 text-sm md:text-base md:px-6 md:py-3 rounded-full font-semibold transition-all duration-300 bg-white/20 text-white hover:bg-white/30" onclick="switchTab('parStock')">
                <i class="fas fa-chart-line mr-1 md:mr-2"></i><span class="whitespace-nowrap">PAR Stock</span>
            </button>
            <button class="tab px-4 py-2.5 text-sm md:text-base md:px-6 md:py-3 rounded-full font-semibold transition-all duration-300 bg-white/20 text-white hover:bg-white/30" onclick="switchTab('groupItems')">
                <i class="fas fa-cocktail mr-1 md:mr-2"></i><span class="whitespace-nowrap">Cocktail Groups</span>
            </button>
        </div>

        <!-- Daily Sale Upload Section -->
        <div id="dailySaleSection" class="section active bg-white rounded-2xl shadow-2xl p-8 glow-effect">
            <h2 class="text-3xl font-bold text-nage-purple mb-6 flex items-center">
                <i class="fas fa-file-upload mr-3"></i>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
            </h2>

            <div class="upload-area-border rounded-xl p-12 text-center bg-purple-50 cursor-pointer hover:bg-purple-100 transition-all duration-300 mb-6" id="dailyUploadArea">
                <div class="text-6xl mb-4">üìÅ</div>
                <div class="text-xl font-semibold text-gray-700 mb-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
                <div class="text-sm text-gray-500">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xls ‡πÅ‡∏•‡∏∞ .xlsx</div>
                <input type="file" id="dailyFileInput" accept=".xls,.xlsx" class="hidden">
            </div>

            <div class="text-center mb-6">
                <button class="px-8 py-3 bg-gradient-to-r from-nage-purple to-purple-dark text-white font-semibold rounded-full shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" id="uploadDailyBtn" disabled>
                    <i class="fas fa-cloud-upload-alt mr-2"></i>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>

            <div class="loading" id="dailyLoading">
                <div class="spinner"></div>
                <p class="mt-4 text-nage-purple font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <div class="message" id="dailyMessage"></div>

            <!-- View Uploaded Daily Sales -->
            <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß</h3>

                <div class="date-selector">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <select id="viewDailySaleDate" onchange="loadDailySaleItems()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>
                    </select>
                </div>

                <div class="loading" id="viewDailyLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #667eea;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>

                <div id="dailySaleItemsResult"></div>
            </div>

            <!-- Conversion Rate Selection Table -->
            <div id="conversionSection" style="display: none;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Conversion Rate ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Match ‡∏ä‡∏∑‡πà‡∏≠</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏≥ fuzzy matching ‡∏Å‡∏±‡∏ö PAR Stock ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö conversion rate ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß
                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏≤‡∏Å‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                </p>

                <table class="conversion-table" id="conversionTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Daily Sale</th>
                            <th>‚ûú Match ‡∏Å‡∏±‡∏ö PAR</th>
                            <th>Category</th>
                            <th style="width: 100px; text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="width: 180px;">Conversion Rate</th>
                        </tr>
                    </thead>
                    <tbody id="conversionTableBody">
                    </tbody>
                </table>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="saveWithConversion()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</button>
                </div>
            </div>
        </div>

        <!-- Daily Transfer Section -->
        <div id="dailyTransferSection" class="section bg-white rounded-2xl shadow-2xl p-8 glow-effect">
            <h2 class="text-3xl font-bold text-nage-purple mb-6 flex items-center">
                <i class="fas fa-exchange-alt mr-3"></i>Transfer ‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å
            </h2>

            <div class="date-selector" style="margin-bottom: 20px;">
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Transfer:</label>
                <input type="date" id="transferDate">
            </div>

            <div style="margin-bottom: 30px;">
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <label style="cursor: pointer; flex: 1; max-width: 280px;">
                        <input type="radio" name="transferDirection" value="in" checked style="display: none;">
                        <div class="transfer-option transfer-in" onclick="this.previousElementSibling.checked = true; updateTransferSelection();" style="padding: 20px; border: 3px solid #4CAF50; border-radius: 12px; text-align: center; transition: all 0.3s ease; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì•</div>
                            <div style="font-size: 22px; font-weight: bold; color: #2e7d32; margin-bottom: 5px;">TRANSFER IN</div>
                            <div style="font-size: 16px; color: #388e3c; font-weight: 600;">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (+)</div>
                        </div>
                    </label>
                    <label style="cursor: pointer; flex: 1; max-width: 280px;">
                        <input type="radio" name="transferDirection" value="out" style="display: none;">
                        <div class="transfer-option transfer-out" onclick="this.previousElementSibling.checked = true; updateTransferSelection();" style="padding: 20px; border: 3px solid #e0e0e0; border-radius: 12px; text-align: center; transition: all 0.3s ease; background: #f5f5f5;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üì§</div>
                            <div style="font-size: 22px; font-weight: bold; color: #666; margin-bottom: 5px;">TRANSFER OUT</div>
                            <div style="font-size: 16px; color: #777; font-weight: 600;">‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (-)</div>
                        </div>
                    </label>
                </div>
            </div>

            <script>
            function updateTransferSelection() {
                const inRadio = document.querySelector('input[name="transferDirection"][value="in"]');
                const outRadio = document.querySelector('input[name="transferDirection"][value="out"]');
                const inDiv = document.querySelector('.transfer-in');
                const outDiv = document.querySelector('.transfer-out');

                if (inRadio.checked) {
                    inDiv.style.border = '3px solid #4CAF50';
                    inDiv.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
                    inDiv.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.3)';
                    inDiv.style.transform = 'scale(1.02)';

                    outDiv.style.border = '3px solid #e0e0e0';
                    outDiv.style.background = '#f5f5f5';
                    outDiv.style.boxShadow = 'none';
                    outDiv.style.transform = 'scale(1)';
                } else {
                    outDiv.style.border = '3px solid #f44336';
                    outDiv.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
                    outDiv.style.boxShadow = '0 4px 15px rgba(244, 67, 54, 0.3)';
                    outDiv.style.transform = 'scale(1.02)';

                    inDiv.style.border = '3px solid #e0e0e0';
                    inDiv.style.background = '#f5f5f5';
                    inDiv.style.boxShadow = 'none';
                    inDiv.style.transform = 'scale(1)';
                }
            }

            // Initialize on load
            document.addEventListener('DOMContentLoaded', () => {
                updateTransferSelection();
                document.querySelectorAll('input[name="transferDirection"]').forEach(radio => {
                    radio.addEventListener('change', updateTransferSelection);
                });
            });
            </script>

            <div style="margin-bottom: 20px;">
                <label for="transferPasteData" style="display: block; margin-bottom: 10px; font-weight: bold;">
                    Copy-Paste ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transfer:
                </label>
                <textarea
                    id="transferPasteData"
                    style="width: 100%; min-height: 200px; font-family: monospace; padding: 10px; border: 2px solid #667eea; border-radius: 8px;"
                    placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• copy ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...&#10;&#10;‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:&#10;Article	Quantity	Total&#10;Beer, Asahi, S bottle, 33cl (99-200013)	24	THB 940.19&#10;Champagne, Taittinger, prestige brut (99-814991)	3	THB 5,548.24&#10;Gin, Anong, 40%, 750ml (99-905966)	2	THB 1,580.00"
                ></textarea>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn" onclick="parseTransferData()">üîç Parse ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div class="loading" id="transferLoading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #667eea;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
            </div>

            <div class="message" id="transferMessage"></div>

            <!-- Transfer Items Table -->
            <div id="transferItemsContainer" style="display: none; margin-top: 30px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transfer ‡∏ó‡∏µ‡πà‡∏û‡∏ö</h3>
                <div id="transferItemsTable"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="saveTransferData()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transfer</button>
                </div>
            </div>

            <!-- View Uploaded Transfers -->
            <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transfer ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h3>

                <div class="date-selector">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <select id="viewTransferDate" onchange="loadTransferItems()">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>
                    </select>
                </div>

                <div class="loading" id="viewTransferLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #667eea;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>

                <div id="viewTransferTable"></div>
            </div>
        </div>

        <!-- PAR Stock & Summary Section -->
        <div id="parStockSection" class="section bg-white rounded-2xl shadow-2xl p-8 glow-effect">
            <h2 class="text-3xl font-bold text-nage-purple mb-8 flex items-center border-b-2 border-nage-purple pb-4">
                <i class="fas fa-chart-line mr-3"></i>PAR Stock & Summary
            </h2>

            <!-- Upload PAR Stock Card -->
            <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl p-6 mb-8 border-2 border-nage-purple/30">
                <h3 class="text-2xl font-bold text-nage-purple mb-4 flex items-center">
                    <i class="fas fa-upload mr-2"></i>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î PAR Stock
                </h3>

                <div class="flex flex-wrap gap-4 items-end">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô PAR:</label>
                        <input type="date" id="parStartDate" class="w-full px-4 py-2 border-2 border-nage-purple/30 rounded-lg focus:border-nage-purple focus:ring-2 focus:ring-nage-purple/20 transition-all">
                    </div>
                    <input type="file" id="parFileInput" accept=".xls,.xlsx" class="hidden">
                    <button class="px-6 py-2 bg-white border-2 border-nage-purple text-nage-purple font-semibold rounded-lg hover:bg-nage-purple hover:text-white transition-all duration-300" onclick="document.getElementById('parFileInput').click()">
                        <i class="fas fa-folder-open mr-2"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PAR Stock
                    </button>
                    <button class="px-6 py-2 bg-nage-purple text-white font-semibold rounded-lg hover:bg-purple-dark shadow-lg hover:shadow-xl transition-all duration-300 disabled:bg-gray-300 disabled:cursor-not-allowed" id="uploadParBtn" onclick="uploadParStock()" disabled>
                        <i class="fas fa-cloud-upload-alt mr-2"></i>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î PAR
                    </button>
                </div>

                <div class="loading mt-4" id="parLoading">
                    <div class="spinner"></div>
                    <p class="mt-4 text-nage-purple font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î...</p>
                </div>

                <div class="message mt-4" id="parMessage"></div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200">

            <!-- Summary Section Card -->
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-emerald-300/50">
                <h3 class="text-2xl font-bold text-emerald-700 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2"></i>‡∏î‡∏π Summary ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                </h3>

                <div class="flex flex-wrap gap-4 items-end mb-4">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PAR Period:</label>
                        <select id="parPeriodSelect" onchange="loadDateRangeForPar()" class="w-full px-4 py-2 border-2 border-emerald-300/50 rounded-lg focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PAR Period --</option>
                        </select>
                    </div>

                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="endDateSelect" class="w-full px-4 py-2 border-2 border-emerald-300/50 rounded-lg focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 transition-all">
                    </div>

                    <button class="px-6 py-2 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 shadow-lg hover:shadow-xl transition-all duration-300" onclick="loadSummary()">
                        <i class="fas fa-chart-pie mr-2"></i>‡πÅ‡∏™‡∏î‡∏á Summary
                    </button>
                    <button class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 shadow-lg hover:shadow-xl transition-all duration-300" onclick="exportSummaryToExcel()">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                </div>

                <!-- Transfer Info -->
                <div id="transferInfoBox" class="hidden mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                    <h4 class="font-bold text-blue-700 mb-2 flex items-center">
                        <i class="fas fa-box mr-2"></i>Transfer ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ:
                    </h4>
                    <div id="transferDatesList"></div>
                </div>

                <div class="loading mt-4" id="summaryLoading">
                    <div class="spinner"></div>
                    <p class="mt-4 text-emerald-700 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p>
                </div>
                <div class="message mt-4" id="summaryMessage"></div>

                <!-- Item Search Box -->
                <div id="itemSearchBox" class="hidden mt-6 p-6 bg-white rounded-xl border-2 border-nage-purple/30 shadow-lg">
                    <h4 class="text-xl font-bold text-nage-purple mb-4 flex items-center">
                        <i class="fas fa-search mr-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </h4>

                    <div class="relative">
                        <input
                            type="text"
                            id="itemSearchInput"
                            placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
                            class="w-full px-4 py-3 border-2 border-nage-purple/30 rounded-lg focus:border-nage-purple focus:ring-2 focus:ring-nage-purple/20 transition-all pr-10"
                            autocomplete="off"
                        >
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>

                        <!-- Autocomplete Dropdown -->
                        <div id="autocompleteResults" class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-nage-purple/30 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                        </div>
                    </div>

                    <!-- Selected Item Detail -->
                    <div id="selectedItemDetail" class="hidden mt-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border-l-4 border-nage-purple">
                    </div>
                </div>

                <div id="summaryResult" class="mt-6"></div>
            </div>
        </div>

        <!-- Group Items Management Section -->
        <div id="groupItemsSection" class="section bg-white rounded-2xl shadow-2xl p-8 glow-effect">
            <h2 class="text-3xl font-bold text-nage-purple mb-6 flex items-center">
                <i class="fas fa-cocktail mr-3"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Cocktail Groups
            </h2>
            <p class="text-gray-600 mb-6">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î stock ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô Cocktails</p>

            <div style="margin: 20px 0;">
                <button class="btn" onclick="showAddGroupItemForm()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <!-- Add/Edit Form -->
            <div id="groupItemFormContainer" style="display: none; background: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 id="formTitle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</h3>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô Margarita):</label>
                    <input type="text" id="groupItemName" style="width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):</label>
                    <input type="text" id="groupItemDescription" style="width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 5px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î Stock:</label>

                    <div id="subItemsList"></div>

                    <button class="btn" onclick="addSubItemRow()" style="margin-top: 10px;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>

                <div style="text-align: right;">
                    <button class="btn" onclick="cancelGroupItemForm()" style="background: #6b7280;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn" onclick="saveGroupItem()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>

            <div class="loading" id="groupItemsLoading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #667eea;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>

            <div class="message" id="groupItemsMessage"></div>

            <!-- Group Items List -->
            <div id="groupItemsList"></div>
        </div>
    </div>

    <script>
        let dailySalesData = null;
        let selectedDailyFile = null;

        // Daily Sale Upload
        document.getElementById('dailyUploadArea').addEventListener('click', () => {
            document.getElementById('dailyFileInput').click();
        });

        document.getElementById('dailyFileInput').addEventListener('change', (e) => {
            selectedDailyFile = e.target.files[0];
            if (selectedDailyFile) {
                document.getElementById('uploadDailyBtn').disabled = false;
                document.querySelector('.upload-text').textContent = `‡πÑ‡∏ü‡∏•‡πå: ${selectedDailyFile.name}`;
            }
        });

        document.getElementById('uploadDailyBtn').addEventListener('click', async () => {
            if (!selectedDailyFile) return;

            const formData = new FormData();
            formData.append('file', selectedDailyFile);

            const loading = document.getElementById('dailyLoading');
            const message = document.getElementById('dailyMessage');
            const conversionSection = document.getElementById('conversionSection');

            loading.style.display = 'block';
            message.style.display = 'none';
            conversionSection.style.display = 'none';

            try {
                const response = await fetch('/api/preview-daily-sale', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

                dailySalesData = data;
                displayConversionTable(data);
                conversionSection.style.display = 'block';

                message.className = 'message success';
                message.textContent = `‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö ${data.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(data.date)}`;
                message.style.display = 'block';

            } catch (error) {
                message.className = 'message error';
                message.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                message.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        });

        function displayConversionTable(data) {
            const tbody = document.getElementById('conversionTableBody');
            tbody.innerHTML = '';

            data.items.forEach((item, index) => {
                const tr = document.createElement('tr');

                // Auto-detect conversion rate using complex logic
                let autoRate = 1;
                const category = (item.category || '').toLowerCase();
                const salesName = item.name;
                const salesNameLower = salesName.toLowerCase();

                // Get PAR name for matching bottle size
                let parName = '';
                let parNameLower = '';
                if (data.parMatches && data.parMatches.matches) {
                    const match = data.parMatches.matches[index];
                    if (match && match.matched && match.salesName) {
                        parName = match.salesName;
                        parNameLower = parName.toLowerCase();
                    }
                }

                // Check if this is Wine or Beer (should NOT be converted to Oz)
                const isWine = category.includes('wine') || category.includes('champagne') ||
                              salesNameLower.includes('wine') || salesNameLower.includes('champagne') ||
                              parNameLower.includes('wine') || parNameLower.includes('champagne');

                const isBeer = category.includes('beer') || category.includes('lager') ||
                              salesNameLower.includes('beer') || salesNameLower.includes('lager') ||
                              parNameLower.includes('beer') || parNameLower.includes('lager');

                // Check if this is Spirit by checking PAR stock name for spirit types
                const isSpirit = parNameLower.includes('vodka') ||
                                parNameLower.includes('gin') ||
                                parNameLower.includes('rum') ||
                                parNameLower.includes('tequila') ||
                                parNameLower.includes('whisky') ||
                                parNameLower.includes('whiskey') ||
                                parNameLower.includes('bourbon') ||
                                parNameLower.includes('cognac') ||
                                parNameLower.includes('brandy') ||
                                parNameLower.includes('aperitif') ||
                                parNameLower.includes('liqueur') ||
                                parNameLower.includes('mezcal') ||
                                parNameLower.includes('grappa') ||
                                parNameLower.includes('sake');

                // Wine Pairing X Glasses (e.g. "Wine Pairing 3 Glasses") = 1.0 (quantity of sales)
                if (/wine pairing.*\d+\s*glasses?/i.test(salesName)) {
                    autoRate = 1; // 1/1 - This is a sale quantity, not wine quantity
                }
                // Wine Pairing (starts with number 0. to 13.)
                else if (/^(0\.|1\.|2\.|3\.|4\.|5\.|6\.|7\.|8\.|9\.|10\.|11\.|12\.|13\.)/.test(salesName)) {
                    if (/^11\./.test(salesName)) {
                        autoRate = 0.2; // 1/5 for 11.x items
                    } else {
                        autoRate = 0.142857; // 1/7 for other numbered items
                    }
                }
                // Wine by Glass (RWG, CHMG, WWG, ROG)
                else if (/RWG|CHMG|WWG|ROG/i.test(salesName)) {
                    autoRate = 0.2; // 1/5
                }
                // Wine by Glass or Wine Pairing
                else if (category.includes('wine by glass') || salesNameLower.includes('wine by glass')) {
                    autoRate = 0.2; // 1/5
                } else if (category.includes('wine pairing') || salesNameLower.includes('wine pairing')) {
                    autoRate = 0.142857; // 1/7
                }
                // Beer = Bottle (no conversion)
                else if (isBeer) {
                    autoRate = 1; // Bottle
                }
                // Spirit (DEFAULT = 2 Oz) - Check from PAR stock name
                else if (isSpirit) {
                    let bottleMultiplier = 0.04; // Default to 75cl (most common)

                    // Check bottle size in PAR name
                    if (parNameLower.includes('1l') || parNameLower.includes('1 l') || parNameLower.includes('1000ml')) {
                        bottleMultiplier = 0.0303030303; // 33 units per liter (1 Oz base)
                    } else if (parNameLower.includes('75cl') || parNameLower.includes('750ml')) {
                        bottleMultiplier = 0.04; // 25 units per 75cl (1 Oz base)
                    } else if (parNameLower.includes('70cl') || parNameLower.includes('700ml')) {
                        bottleMultiplier = 0.04347826087; // 23 units per 70cl (1 Oz base)
                    } else if (parNameLower.includes('50cl') || parNameLower.includes('500ml')) {
                        bottleMultiplier = 0.0625; // 16 units per 50cl (1 Oz base)
                    }

                    // Default to 2 Oz for all spirits (vodka, gin, whisky, rum, tequila, etc.)
                    autoRate = bottleMultiplier * 2;
                }

                // Find PAR match for this item
                let parMatch = null;
                let matchScore = 0;
                if (data.parMatches && data.parMatches.matches) {
                    const match = data.parMatches.matches[index];
                    if (match && match.matched) {
                        parMatch = match.salesName;
                        matchScore = match.matchScore;
                    }
                }

                const matchStyle = parMatch ?
                    (matchScore >= 0.8 ? 'background: #d1fae5; color: #065f46;' :
                     matchScore >= 0.6 ? 'background: #fef3c7; color: #92400e;' : '') :
                    'background: #fee2e2; color: #991b1b;';

                // Build PAR match cell - Always allow editing
                let parMatchCell;
                if (data.parMatches && data.parMatches.parItems) {
                    const parItems = data.parMatches.parItems;

                    if (parMatch) {
                        // Matched item - show editable input with matched value
                        parMatchCell = `
                            <td style="${matchStyle} padding: 8px;">
                                <div style="margin-bottom: 4px;">
                                    <small style="font-size: 11px; opacity: 0.8;">‚úì Match ${(matchScore * 100).toFixed(0)}% - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å‡∏ú‡∏¥‡∏î:</small>
                                </div>
                                <input type="text"
                                    class="par-search-input"
                                    data-index="${index}"
                                    value="${parMatch}"
                                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PAR item..."
                                    list="parList${index}"
                                    style="width: 100%; padding: 6px; border: 2px solid ${matchScore >= 0.8 ? '#10b981' : '#f59e0b'}; border-radius: 5px; font-size: 13px;">
                                <datalist id="parList${index}">
                                    ${parItems.map(p => `<option value="${p.name}">`).join('')}
                                </datalist>
                            </td>
                        `;
                    } else {
                        // Not matched - show empty searchable input
                        parMatchCell = `
                            <td style="${matchStyle} padding: 8px;">
                                <input type="text"
                                    class="par-search-input"
                                    data-index="${index}"
                                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PAR item..."
                                    list="parList${index}"
                                    style="width: 100%; padding: 6px; border: 2px solid #f59e0b; border-radius: 5px; font-size: 13px;">
                                <datalist id="parList${index}">
                                    ${parItems.map(p => `<option value="${p.name}">`).join('')}
                                </datalist>
                                <small style="color: #991b1b; font-size: 11px;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô PAR - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</small>
                            </td>
                        `;
                    }
                } else {
                    parMatchCell = `
                        <td style="${matchStyle} padding: 8px;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ PAR Stock</td>
                    `;
                }

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    ${parMatchCell}
                    <td>${item.category || '-'}</td>
                    <td style="text-align: right;">${item.qty.toFixed(2)}</td>
                    <td>
                        <select class="conversion-select" data-index="${index}" data-par-name="${parMatch || ''}">
                            <option value="1" ${autoRate === 1 ? 'selected' : ''}>1/1 (1.0) - Bottle</option>
                            <option value="0.2" ${autoRate === 0.2 ? 'selected' : ''}>1/5 (0.2) - Wine by glass</option>
                            <option value="0.142857" ${Math.abs(autoRate - 0.142857) < 0.0001 ? 'selected' : ''}>1/7 (0.143) - Wine pairing</option>
                            <option value="0.0625" ${Math.abs(autoRate - 0.0625) < 0.0001 ? 'selected' : ''}>1/16 (0.063) - 50cl Spirit</option>
                            <option value="0.05" ${Math.abs(autoRate - 0.05) < 0.0001 ? 'selected' : ''}>1/20 (0.050)</option>
                            <option value="0.04347826087" ${Math.abs(autoRate - 0.04347826087) < 0.0001 ? 'selected' : ''}>1/23 (0.043) - 70cl Spirit</option>
                            <option value="0.04" ${Math.abs(autoRate - 0.04) < 0.0001 ? 'selected' : ''}>1/25 (0.040) - 75cl Spirit</option>
                            <option value="0.0303030303" ${Math.abs(autoRate - 0.0303030303) < 0.0001 ? 'selected' : ''}>1/33 (0.030) - 1L Spirit</option>
                            <option value="0.125" ${Math.abs(autoRate - 0.125) < 0.0001 ? 'selected' : ''}>2/16 (0.125) - 50cl 2Oz</option>
                            <option value="0.087" ${Math.abs(autoRate - 0.087) < 0.0001 ? 'selected' : ''}>2/23 (0.087) - 70cl 2Oz</option>
                            <option value="0.08" ${Math.abs(autoRate - 0.08) < 0.0001 ? 'selected' : ''}>2/25 (0.080) - 75cl 2Oz</option>
                            <option value="0.0606" ${Math.abs(autoRate - 0.0606) < 0.0001 ? 'selected' : ''}>2/33 (0.061) - 1L 2Oz</option>
                        </select>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        async function saveWithConversion() {
            if (!dailySalesData) return;

            // Collect conversion rates and use PAR names
            const conversionRates = {};
            const itemsWithParNames = [];
            const selects = document.querySelectorAll('.conversion-select');

            selects.forEach(select => {
                const index = parseInt(select.getAttribute('data-index'));
                let parName = select.getAttribute('data-par-name');
                const originalItem = dailySalesData.items[index];

                // Check if user manually selected a PAR item from search input
                const searchInput = document.querySelector(`.par-search-input[data-index="${index}"]`);
                if (searchInput && searchInput.value.trim()) {
                    parName = searchInput.value.trim();
                }

                // Use PAR name if available, otherwise keep original name
                const finalName = parName || originalItem.name;
                const convRate = parseFloat(select.value);

                itemsWithParNames.push({
                    ...originalItem,
                    name: finalName,
                    originalName: originalItem.name,
                    conversionRate: convRate
                });

                conversionRates[finalName] = convRate;
            });

            const loading = document.getElementById('dailyLoading');
            const message = document.getElementById('dailyMessage');

            loading.style.display = 'block';

            try {
                const response = await fetch('/api/save-daily-sale', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: dailySalesData.date,
                        items: itemsWithParNames, // Use items with PAR names
                        summary: dailySalesData.summary,
                        conversionRates: conversionRates
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

                message.className = 'message success';
                message.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(dailySalesData.date)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                message.style.display = 'block';

                // Reset
                document.getElementById('conversionSection').style.display = 'none';
                document.getElementById('dailyFileInput').value = '';
                document.getElementById('uploadDailyBtn').disabled = true;
                document.querySelector('.upload-text').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢';
                dailySalesData = null;
                selectedDailyFile = null;

                // Reload daily sale dates
                await loadDailySaleDates();

            } catch (error) {
                message.className = 'message error';
                message.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                message.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        // PAR Stock Upload
        document.getElementById('parFileInput').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                document.getElementById('uploadParBtn').disabled = false;
            }
        });

        async function uploadParStock() {
            const startDate = document.getElementById('parStartDate').value;
            const fileInput = document.getElementById('parFileInput');

            if (!startDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô PAR');
                return;
            }

            if (!fileInput.files[0]) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PAR Stock');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('startDate', startDate);

            const loading = document.getElementById('parLoading');
            const message = document.getElementById('parMessage');

            loading.style.display = 'block';
            message.style.display = 'none';

            try {
                const response = await fetch('/api/upload-par', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

                message.className = 'message success';
                message.textContent = `‚úÖ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î PAR Stock ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(startDate)}, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${data.summary.totalItems}`;
                message.style.display = 'block';

                // Reset
                fileInput.value = '';
                document.getElementById('parStartDate').value = '';
                document.getElementById('uploadParBtn').disabled = true;

                // Reload PAR periods
                await loadParPeriods();

            } catch (error) {
                message.className = 'message error';
                message.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
                message.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadParPeriods() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                const select = document.getElementById('parPeriodSelect');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PAR Period --</option>';

                if (data.parPeriods && data.parPeriods.length > 0) {
                    data.parPeriods.forEach(startDate => {
                        const option = document.createElement('option');
                        option.value = startDate;
                        option.textContent = `PAR ‡πÄ‡∏£‡∏¥‡πà‡∏° ${formatThaiDate(startDate)}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading PAR periods:', error);
            }
        }

        async function loadDateRangeForPar() {
            const parStartDate = document.getElementById('parPeriodSelect').value;
            if (parStartDate) {
                try {
                    // Get PAR period date range
                    const response = await fetch(`/api/dates-in-par-period/${parStartDate}`);
                    const data = await response.json();

                    if (response.ok && data.dateRange) {
                        const { startDate, endDate } = data.dateRange;
                        const endDateInput = document.getElementById('endDateSelect');

                        // Set min and max date for the input
                        endDateInput.min = startDate;
                        endDateInput.max = endDate;

                        // Set default to PAR period end date
                        endDateInput.value = endDate;

                        // Store PAR end date for validation
                        endDateInput.dataset.parEndDate = endDate;
                    }
                } catch (error) {
                    console.error('Error loading PAR date range:', error);
                }

                // Load transfer dates for this period
                await loadTransferDatesForPeriod(parStartDate);
            }
        }

        async function loadTransferDatesForPeriod(parStartDate) {
            try {
                // Get date range for this PAR period
                const dateRangeResponse = await fetch(`/api/dates-in-par-period/${parStartDate}`);
                const dateRangeData = await dateRangeResponse.json();

                if (!dateRangeResponse.ok) {
                    console.error('Failed to get date range');
                    return;
                }

                const { startDate, endDate } = dateRangeData.dateRange;

                // Get all transfer dates
                const transferResponse = await fetch('/api/transfer-dates');
                const transferData = await transferResponse.json();

                if (!transferResponse.ok) {
                    console.error('Failed to get transfer dates');
                    return;
                }

                // Filter transfers within this PAR period
                const transfersInPeriod = transferData.dates.filter(date =>
                    date >= startDate && date <= endDate
                );

                // Hide transfer info box - not needed in summary
                const infoBox = document.getElementById('transferInfoBox');
                infoBox.style.display = 'none';

            } catch (error) {
                console.error('Error loading transfer dates:', error);
            }
        }

        async function viewTransferDetail(date) {
            try {
                const response = await fetch(`/api/daily-transfer/${date}`);
                const data = await response.json();

                if (!response.ok) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transfer');
                    return;
                }

                // Switch to transfer tab and load this date
                switchTab('dailyTransfer');
                document.getElementById('viewTransferDate').value = date;
                loadTransferItems();

            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function loadSummary() {
            const parStartDate = document.getElementById('parPeriodSelect').value;
            const endDateInput = document.getElementById('endDateSelect');
            const endDate = endDateInput.value;

            if (!parStartDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PAR Period');
                return;
            }

            if (!endDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                return;
            }

            // Validate end date is within PAR period
            const parEndDate = endDateInput.dataset.parEndDate;
            if (parEndDate && endDate > parEndDate) {
                alert(`‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${formatThaiDate(parEndDate)}\n\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏ô‡∏Å‡∏±‡∏ö PAR Period ‡πÉ‡∏´‡∏°‡πà`);
                endDateInput.value = parEndDate;
                return;
            }

            const loading = document.getElementById('summaryLoading');
            const result = document.getElementById('summaryResult');

            loading.style.display = 'block';
            result.innerHTML = '';

            try {
                const response = await fetch(`/api/summary/${parStartDate}/${endDate}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

                displaySummary(data);

            } catch (error) {
                result.innerHTML = `<div class="message error">${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        async function exportSummaryToExcel() {
            const parStartDate = document.getElementById('parPeriodSelect').value;
            const endDateInput = document.getElementById('endDateSelect');
            const endDate = endDateInput.value;

            if (!parStartDate) {
                showMessage('summaryMessage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PAR Period', 'error');
                return;
            }

            if (!endDate) {
                showMessage('summaryMessage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'error');
                return;
            }

            // Validate end date is within PAR period
            const parEndDate = endDateInput.dataset.parEndDate;
            if (parEndDate && endDate > parEndDate) {
                alert(`‚ö†Ô∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${formatThaiDate(parEndDate)}\n\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏ô‡∏Å‡∏±‡∏ö PAR Period ‡πÉ‡∏´‡∏°‡πà`);
                endDateInput.value = parEndDate;
                return;
            }

            try {
                const response = await fetch(`/api/export-summary/${parStartDate}/${endDate}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

                // Download the file
                window.open(data.excelReportUrl, '_blank');
                showMessage('summaryMessage', '‚úÖ Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

            } catch (error) {
                showMessage('summaryMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }

        function displaySummary(data) {
            const result = document.getElementById('summaryResult');

            let html = `
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th style="width: 100px; text-align: right;">PAR Stock</th>
                            <th style="width: 100px; text-align: right;">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ (converted)</th>
                            <th style="width: 90px; text-align: right;">Transfer</th>
                            <th style="width: 100px; text-align: right;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                            <th style="width: 200px;">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.comparison.forEach((item, index) => {
                let statusClass = 'status-ok';
                let progressClass = '';
                let rowStyle = '';

                if (item.type === 'unmatched_sale') {
                    // Unmatched sales - show in yellow
                    rowStyle = 'background: #fef3c7;';
                    statusClass = 'status-warning';
                } else {
                    // PAR items
                    if (item.usagePercent > 100) {
                        statusClass = 'status-critical';
                        progressClass = 'critical';
                    } else if (item.usagePercent > 80) {
                        statusClass = 'status-warning';
                        progressClass = 'warning';
                    }
                }

                const usageWidth = Math.min(item.usagePercent, 100);

                // Transfer display logic
                const transferQty = item.transferQty || 0;
                let transferDisplay = '';
                if (transferQty > 0) {
                    transferDisplay = `<span style="color: #059669; font-weight: bold;">+${transferQty.toFixed(2)}</span>`;
                } else if (transferQty < 0) {
                    transferDisplay = `<span style="color: #dc2626; font-weight: bold;">${transferQty.toFixed(2)}</span>`;
                } else {
                    transferDisplay = `<span style="color: #9ca3af;">-</span>`;
                }

                // Remaining stock color coding
                let remainingColor = '';
                let remainingBg = '';
                const remaining = item.remaining;

                if (remaining < 0) {
                    // Negative - Red (‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏¥‡∏ô PAR)
                    remainingColor = 'color: #dc2626; font-weight: bold;';
                    remainingBg = 'background: #fee2e2;';
                } else if (remaining === 0) {
                    // Zero - Orange (‡∏´‡∏°‡∏î)
                    remainingColor = 'color: #ea580c; font-weight: bold;';
                    remainingBg = 'background: #ffedd5;';
                } else if (remaining > 0 && remaining < 2) {
                    // Low stock (0 < x < 2) - Yellow (‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î)
                    remainingColor = 'color: #d97706; font-weight: bold;';
                    remainingBg = 'background: #fef3c7;';
                }
                // >= 2 is normal (no special color)

                html += `
                    <tr style="${rowStyle}">
                        <td>${index + 1}</td>
                        <td>
                            ${item.name}
                            ${item.matchedName ? `<br><small style="color: #666; font-style: italic;">‚Üí ${item.matchedName}</small>` : ''}
                            ${item.type === 'unmatched_sale' ? '<br><small style="color: #f59e0b; font-weight: bold;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô PAR</small>' : ''}
                        </td>
                        <td style="text-align: right;">${item.parStock.toFixed(2)}</td>
                        <td style="text-align: right;">${item.convertedSoldQty.toFixed(2)}</td>
                        <td style="text-align: right;">${transferDisplay}</td>
                        <td style="text-align: right; ${remainingColor} ${remainingBg}">${item.remaining.toFixed(2)}</td>
                        <td>
                            ${item.type === 'par_item' ? `
                            <div class="progress-bar">
                                <div class="progress-fill ${progressClass}" style="width: ${usageWidth}%"></div>
                            </div>
                            <small class="${statusClass}">${item.usagePercent.toFixed(1)}%</small>
                            ` : '<small style="color: #666;">-</small>'}
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            result.innerHTML = html;

            // Show item search box and initialize autocomplete
            document.getElementById('itemSearchBox').classList.remove('hidden');
            initItemSearch(data.comparison);
        }

        // Item Search with Autocomplete
        let summaryData = [];

        function initItemSearch(comparisonData) {
            summaryData = comparisonData;
            const searchInput = document.getElementById('itemSearchInput');
            const autocompleteResults = document.getElementById('autocompleteResults');
            const selectedItemDetail = document.getElementById('selectedItemDetail');

            // Clear previous
            searchInput.value = '';
            selectedItemDetail.innerHTML = '';
            selectedItemDetail.classList.add('hidden');
            autocompleteResults.classList.add('hidden');

            // Input event - show autocomplete
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim().toLowerCase();

                if (query.length < 1) {
                    autocompleteResults.classList.add('hidden');
                    return;
                }

                // Filter items
                const filtered = summaryData.filter(item =>
                    item.name.toLowerCase().includes(query)
                );

                if (filtered.length === 0) {
                    autocompleteResults.classList.add('hidden');
                    return;
                }

                // Display autocomplete results
                let html = '';
                filtered.slice(0, 10).forEach(item => {
                    const statusIcon = item.type === 'unmatched_sale' ? '‚ö†Ô∏è' :
                                      item.usagePercent > 100 ? 'üî¥' :
                                      item.usagePercent > 80 ? 'üü°' : 'üü¢';

                    html += `
                        <div class="autocomplete-item p-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 transition-colors" onclick="selectItem('${item.name.replace(/'/g, "\\'")}')">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${statusIcon} ${item.name}</div>
                                    ${item.matchedName ? `<div class="text-xs text-gray-500 mt-1">‚Üí ${item.matchedName}</div>` : ''}
                                </div>
                                <div class="text-sm text-nage-purple font-bold ml-4">
                                    ${item.usagePercent.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                    `;
                });

                autocompleteResults.innerHTML = html;
                autocompleteResults.classList.remove('hidden');
            });

            // Click outside to close
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#itemSearchBox')) {
                    autocompleteResults.classList.add('hidden');
                }
            });
        }

        function selectItem(itemName) {
            const item = summaryData.find(i => i.name === itemName);
            if (!item) return;

            const autocompleteResults = document.getElementById('autocompleteResults');
            const selectedItemDetail = document.getElementById('selectedItemDetail');
            const searchInput = document.getElementById('itemSearchInput');

            // Close autocomplete
            autocompleteResults.classList.add('hidden');
            searchInput.value = item.name;

            // Calculate colors and status
            let statusClass = '';
            let statusText = '';
            let statusIcon = '';

            if (item.type === 'unmatched_sale') {
                statusClass = 'bg-yellow-100 text-yellow-800';
                statusText = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô PAR Stock';
                statusIcon = '‚ö†Ô∏è';
            } else if (item.usagePercent > 100) {
                statusClass = 'bg-red-100 text-red-800';
                statusText = '‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏¥‡∏ô PAR';
                statusIcon = 'üî¥';
            } else if (item.usagePercent > 80) {
                statusClass = 'bg-yellow-100 text-yellow-800';
                statusText = '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î';
                statusIcon = 'üü°';
            } else {
                statusClass = 'bg-green-100 text-green-800';
                statusText = '‡∏õ‡∏Å‡∏ï‡∏¥';
                statusIcon = 'üü¢';
            }

            const transferQty = item.transferQty || 0;
            let transferDisplay = '';
            let transferClass = '';
            if (transferQty > 0) {
                transferDisplay = `+${transferQty.toFixed(2)}`;
                transferClass = 'text-green-600';
            } else if (transferQty < 0) {
                transferDisplay = `${transferQty.toFixed(2)}`;
                transferClass = 'text-red-600';
            } else {
                transferDisplay = '-';
                transferClass = 'text-gray-400';
            }

            // Display item details
            const html = `
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <h5 class="text-xl font-bold text-nage-purple">${item.name}</h5>
                        ${item.matchedName ? `<p class="text-sm text-gray-600 mt-1">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö: ${item.matchedName}</p>` : ''}
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusClass}">
                        ${statusIcon} ${statusText}
                    </span>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <div class="text-xs text-gray-600 mb-1">PAR Stock</div>
                        <div class="text-2xl font-bold text-nage-purple">${item.parStock.toFixed(2)}</div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <div class="text-xs text-gray-600 mb-1">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ</div>
                        <div class="text-2xl font-bold text-blue-600">${item.convertedSoldQty.toFixed(2)}</div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <div class="text-xs text-gray-600 mb-1">Transfer</div>
                        <div class="text-2xl font-bold ${transferClass}">${transferDisplay}</div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-purple-200">
                        <div class="text-xs text-gray-600 mb-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                        <div class="text-2xl font-bold ${
                            item.remaining < 0 ? 'text-red-600' :
                            item.remaining === 0 ? 'text-orange-600' :
                            item.remaining < 2 ? 'text-yellow-600' :
                            'text-green-600'
                        }">
                            ${item.remaining.toFixed(2)}
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-semibold text-gray-700">‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                        <span class="text-sm font-bold text-nage-purple">${item.usagePercent.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                        <div class="h-full flex items-center justify-center text-white text-xs font-bold transition-all duration-300 ${
                            item.usagePercent > 100 ? 'bg-red-500' :
                            item.usagePercent > 80 ? 'bg-yellow-500' : 'bg-green-500'
                        }" style="width: ${Math.min(item.usagePercent, 100)}%">
                            ${item.usagePercent.toFixed(0)}%
                        </div>
                    </div>
                </div>
            `;

            selectedItemDetail.innerHTML = html;
            selectedItemDetail.classList.remove('hidden');

            // Scroll to detail
            selectedItemDetail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Load Daily Sale Dates
        async function loadDailySaleDates() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                const select = document.getElementById('viewDailySaleDate');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';

                if (data.dailyDates && data.dailyDates.length > 0) {
                    data.dailyDates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = formatThaiDate(date);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading daily sale dates:', error);
            }
        }

        async function loadDailySaleItems() {
            const selectedDate = document.getElementById('viewDailySaleDate').value;

            if (!selectedDate) {
                document.getElementById('dailySaleItemsResult').innerHTML = '';
                return;
            }

            const loading = document.getElementById('viewDailyLoading');
            const result = document.getElementById('dailySaleItemsResult');

            loading.style.display = 'block';
            result.innerHTML = '';

            try {
                const response = await fetch(`/api/daily-sale/${selectedDate}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }

                displayDailySaleItems(data);

            } catch (error) {
                result.innerHTML = `<div class="message error">${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayDailySaleItems(data) {
            const result = document.getElementById('dailySaleItemsResult');

            let html = `
                <div style="background: #f0f9ff; border: 2px solid #0284c7; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong style="color: #0c4a6e;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(data.date)}</strong>
                    <p style="color: #075985; margin-top: 5px; font-size: 14px;">
                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ |
                        ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${data.summary.totalQty.toFixed(2)} ‡∏´‡∏ô‡πà‡∏ß‡∏¢
                    </p>
                </div>

                <table class="conversion-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                            <th>Category</th>
                            <th style="width: 120px; text-align: right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="width: 150px; text-align: center;">Conversion Rate</th>
                            <th style="width: 120px; text-align: right;">Converted Qty</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.items.forEach((item, index) => {
                const convRate = item.conversionRate || 1;
                const convertedQty = item.qty * convRate;

                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.category || '-'}</td>
                        <td style="text-align: right;">${item.qty.toFixed(2)}</td>
                        <td style="text-align: center;">
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 13px;">
                                ${convRate.toFixed(3)}
                            </span>
                        </td>
                        <td style="text-align: right; font-weight: bold; color: #667eea;">
                            ${convertedQty.toFixed(2)}
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            result.innerHTML = html;
        }

        // ========== Group Items Management ==========
        let currentEditingGroupItemId = null;
        let allParStockItems = [];

        async function loadLatestParStock() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.parPeriods && data.parPeriods.length > 0) {
                    const latestParDate = data.parPeriods[0]; // Already sorted descending
                    const parResponse = await fetch(`/api/par-comparison/${latestParDate}`);
                    const parData = await parResponse.json();

                    // The API returns: { success: true, data: { comparison: [...] } }
                    if (parData.data && parData.data.comparison) {
                        allParStockItems = parData.data.comparison.map(item => item.name);
                        console.log('‚úÖ Loaded PAR stock items:', allParStockItems.length);
                    } else {
                        console.log('‚ùå No PAR stock items found in response', parData);
                    }
                } else {
                    console.log('‚ùå No PAR periods available');
                }
            } catch (error) {
                console.error('Error loading PAR stock:', error);
                allParStockItems = [];
            }
        }

        async function loadGroupItems() {
            const loading = document.getElementById('groupItemsLoading');
            const listContainer = document.getElementById('groupItemsList');

            loading.style.display = 'block';
            listContainer.innerHTML = '';

            try {
                // Load PAR stock items first
                await loadLatestParStock();

                const response = await fetch('/api/group-items');
                const data = await response.json();

                if (!response.ok) throw new Error(data.error);

                displayGroupItems(data.items);
            } catch (error) {
                showGroupItemsMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayGroupItems(items) {
            const listContainer = document.getElementById('groupItemsList');

            if (items.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">';

            items.forEach(item => {
                html += `
                    <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 2px solid #667eea; border-radius: 15px; padding: 18px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15); transition: all 0.3s ease; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.25)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.15)';">
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #e5e7eb;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #667eea; font-size: 18px; font-weight: bold;">
                                    <i class="fas fa-cocktail" style="margin-right: 8px;"></i>${item.name}
                                </h3>
                                ${item.description ? `<p style="color: #6b7280; margin: 4px 0 0 0; font-size: 13px;">${item.description}</p>` : ''}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button onclick="editGroupItem('${item.id}')" style="flex: 1; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-edit"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button onclick="deleteGroupItem('${item.id}')" style="flex: 1; padding: 8px 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <i class="fas fa-trash"></i> ‡∏•‡∏ö
                            </button>
                        </div>

                        <!-- Items List -->
                        <div style="background: white; border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;">
                            ${item.subItems.map((sub, idx) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: ${idx % 2 === 0 ? '#f9fafb' : 'white'}; border-radius: 6px; margin-bottom: 4px;">
                                    <div style="flex: 1; font-size: 13px; color: #374151; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${sub.parName}">
                                        ${sub.parName}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; margin-left: 10px;">
                                        <span style="font-size: 14px; font-weight: bold; color: #667eea; min-width: 35px; text-align: right;">${sub.qty}</span>
                                        <span style="font-size: 12px; color: #6b7280; background: #e5e7eb; padding: 2px 8px; border-radius: 4px; min-width: 40px; text-align: center;">${sub.unit}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Item Count Badge -->
                        <div style="position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 11px; font-weight: bold; padding: 4px 10px; border-radius: 12px; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);">
                            ${item.subItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            listContainer.innerHTML = html;
        }

        async function showAddGroupItemForm() {
            currentEditingGroupItemId = null;
            document.getElementById('formTitle').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('groupItemName').value = '';
            document.getElementById('groupItemDescription').value = '';
            document.getElementById('subItemsList').innerHTML = '';

            // Load PAR stock if not already loaded
            if (allParStockItems.length === 0) {
                await loadLatestParStock();
            }

            addSubItemRow(); // Add one empty row
            document.getElementById('groupItemFormContainer').style.display = 'block';
        }

        function cancelGroupItemForm() {
            document.getElementById('groupItemFormContainer').style.display = 'none';
            currentEditingGroupItemId = null;
        }

        function addSubItemRow(parName = '', qty = '', unit = 'oz') {
            const container = document.getElementById('subItemsList');
            const index = container.children.length;

            const row = document.createElement('div');
            row.className = 'sub-item-row';
            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 50px; gap: 10px; margin-bottom: 10px; align-items: center;';

            // Build PAR stock datalist options
            let parOptions = '';
            if (allParStockItems.length > 0) {
                allParStockItems.forEach(itemName => {
                    parOptions += `<option value="${itemName}">`;
                });
                console.log(`üìã Added ${allParStockItems.length} items to datalist for row ${index}`);
            } else {
                console.log('‚ö†Ô∏è No PAR stock items available for datalist');
            }

            row.innerHTML = `
                <input type="text"
                    class="sub-item-parname"
                    value="${parName}"
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PAR Stock... (‡∏°‡∏µ ${allParStockItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)"
                    list="parStockList${index}"
                    autocomplete="off"
                    style="padding: 8px; border: 2px solid #ccc; border-radius: 5px;">
                <datalist id="parStockList${index}">
                    ${parOptions}
                </datalist>
                <input type="number" class="sub-item-qty" value="${qty}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" step="0.01" style="padding: 8px; border: 2px solid #ccc; border-radius: 5px;">
                <select class="sub-item-unit" style="padding: 8px; border: 2px solid #ccc; border-radius: 5px;">
                    <option value="oz" ${unit === 'oz' ? 'selected' : ''}>oz</option>
                    <option value="bottle" ${unit === 'bottle' ? 'selected' : ''}>bottle</option>
                    <option value="glass" ${unit === 'glass' ? 'selected' : ''}>glass</option>
                </select>
                <button onclick="removeSubItemRow(this)" style="padding: 8px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è</button>
            `;

            container.appendChild(row);
        }

        function removeSubItemRow(button) {
            button.parentElement.remove();
        }

        async function saveGroupItem() {
            const name = document.getElementById('groupItemName').value.trim();
            const description = document.getElementById('groupItemDescription').value.trim();

            if (!name) {
                showGroupItemsMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°', 'error');
                return;
            }

            // Collect sub items
            const subItemsRows = document.querySelectorAll('.sub-item-row');
            const subItems = [];

            for (const row of subItemsRows) {
                const parName = row.querySelector('.sub-item-parname').value;
                const qty = parseFloat(row.querySelector('.sub-item-qty').value);
                const unit = row.querySelector('.sub-item-unit').value;

                if (parName && qty > 0) {
                    subItems.push({ parName, qty, unit });
                }
            }

            if (subItems.length === 0) {
                showGroupItemsMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î Stock ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
                return;
            }

            const loading = document.getElementById('groupItemsLoading');
            loading.style.display = 'block';

            try {
                const url = currentEditingGroupItemId
                    ? `/api/group-items/${currentEditingGroupItemId}`
                    : '/api/group-items';

                const method = currentEditingGroupItemId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, subItems })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error);

                showGroupItemsMessage(currentEditingGroupItemId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                cancelGroupItemForm();
                await loadGroupItems();
            } catch (error) {
                showGroupItemsMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function editGroupItem(id) {
            const loading = document.getElementById('groupItemsLoading');
            loading.style.display = 'block';

            try {
                const response = await fetch(`/api/group-items/${id}`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.error);

                const item = data.item;
                currentEditingGroupItemId = id;

                document.getElementById('formTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°';
                document.getElementById('groupItemName').value = item.name;
                document.getElementById('groupItemDescription').value = item.description || '';

                document.getElementById('subItemsList').innerHTML = '';
                item.subItems.forEach(sub => {
                    addSubItemRow(sub.parName, sub.qty, sub.unit);
                });

                document.getElementById('groupItemFormContainer').style.display = 'block';
                document.getElementById('groupItemFormContainer').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showGroupItemsMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function deleteGroupItem(id) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ?')) return;

            const loading = document.getElementById('groupItemsLoading');
            loading.style.display = 'block';

            try {
                const response = await fetch(`/api/group-items/${id}`, { method: 'DELETE' });
                const data = await response.json();

                if (!response.ok) throw new Error(data.error);

                showGroupItemsMessage('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                await loadGroupItems();
            } catch (error) {
                showGroupItemsMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function showGroupItemsMessage(text, type) {
            const message = document.getElementById('groupItemsMessage');
            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';

            setTimeout(() => {
                message.style.display = 'none';
            }, 5000);
        }

        // Tab Switching
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            const sections = document.querySelectorAll('.section');

            // Reset all tabs to inactive state (Tailwind)
            tabs.forEach(t => {
                t.classList.remove('active', 'bg-white', 'text-nage-purple', 'shadow-lg');
                t.classList.add('bg-white/20', 'text-white');
            });

            // Hide all sections
            sections.forEach(s => {
                s.classList.remove('active');
            });

            if (tab === 'dailySale') {
                tabs[0].classList.remove('bg-white/20', 'text-white');
                tabs[0].classList.add('active', 'bg-white', 'text-nage-purple', 'shadow-lg');
                document.getElementById('dailySaleSection').classList.add('active');
                loadDailySaleDates();
            } else if (tab === 'dailyTransfer') {
                tabs[1].classList.remove('bg-white/20', 'text-white');
                tabs[1].classList.add('active', 'bg-white', 'text-nage-purple', 'shadow-lg');
                document.getElementById('dailyTransferSection').classList.add('active');
                loadTransferDates();
            } else if (tab === 'parStock') {
                tabs[2].classList.remove('bg-white/20', 'text-white');
                tabs[2].classList.add('active', 'bg-white', 'text-nage-purple', 'shadow-lg');
                document.getElementById('parStockSection').classList.add('active');
                loadParPeriods();
            } else if (tab === 'groupItems') {
                tabs[3].classList.remove('bg-white/20', 'text-white');
                tabs[3].classList.add('active', 'bg-white', 'text-nage-purple', 'shadow-lg');
                document.getElementById('groupItemsSection').classList.add('active');
                loadGroupItems();
            }
        }

        // Utility Functions
        function formatThaiDate(dateStr) {
            const date = new Date(dateStr);
            const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                               '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
            return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${date.getFullYear() + 543}`;
        }

        function showMessage(elementId, text, type) {
            const message = document.getElementById(elementId);
            if (!message) return;

            message.textContent = text;
            message.className = `message ${type}`;
            message.style.display = 'block';

            setTimeout(() => {
                message.style.display = 'none';
            }, 5000);
        }

        // ===== DAILY TRANSFER FUNCTIONS =====
        let parsedTransferItems = [];

        async function parseTransferData() {
            const pasteData = document.getElementById('transferPasteData').value.trim();
            const transferDate = document.getElementById('transferDate').value;
            const direction = document.querySelector('input[name="transferDirection"]:checked').value;

            if (!pasteData) {
                showMessage('transferMessage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transfer', 'error');
                return;
            }

            if (!transferDate) {
                showMessage('transferMessage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
                return;
            }

            const loading = document.getElementById('transferLoading');
            loading.style.display = 'block';
            document.getElementById('transferItemsContainer').style.display = 'none';

            try {
                // Parse text data
                const lines = pasteData.split('\n').map(line => line.trim()).filter(line => line);
                const items = [];

                console.log('Total lines:', lines.length);
                console.log('First few lines:', lines.slice(0, 5));

                // Detect format: check if first data line has tabs
                let useTabFormat = false;
                if (lines.length > 1 && lines[1].includes('\t')) {
                    useTabFormat = true;
                    console.log('Detected TAB format');
                } else {
                    console.log('Detected NEWLINE format (3 lines per item)');
                }

                if (useTabFormat) {
                    // Original tab-separated format
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i];
                        const columns = line.split('\t');

                        if (columns.length < 2) continue;

                        let name = columns[0].trim();
                        name = name.replace(/\s*\([^)]*\)\s*$/, '').trim();

                        const qty = parseFloat(columns[1].trim());

                        if (isNaN(qty) || qty === 0) continue;

                        items.push({ originalName: name, qty: qty });
                    }
                } else {
                    // New format: 3 lines per item (Name, Quantity, Price)
                    // Skip first line if it looks like header
                    let startIndex = 0;
                    if (lines[0].toLowerCase().includes('article') ||
                        lines[0].toLowerCase().includes('quantity')) {
                        startIndex = 1;
                    }

                    for (let i = startIndex; i < lines.length; i += 3) {
                        // Need at least 2 lines (name + qty), price is optional
                        if (i + 1 >= lines.length) break;

                        const nameLine = lines[i].trim();
                        const qtyLine = lines[i + 1].trim();

                        console.log(`Item ${Math.floor(i/3) + 1}:`, { nameLine, qtyLine });

                        // Extract name (remove code in parentheses)
                        let name = nameLine.replace(/\s*\([^)]*\)\s*$/, '').trim();

                        // Extract quantity
                        const qty = parseFloat(qtyLine);

                        console.log(`Parsed - Name: "${name}", Qty: ${qty}`);

                        if (isNaN(qty) || qty === 0) {
                            console.log('Skipping - qty is 0 or invalid');
                            continue;
                        }

                        items.push({
                            originalName: name,
                            qty: qty
                        });
                    }
                }

                console.log('Final items:', items);

                if (items.length === 0) {
                    showMessage('transferMessage', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ Quantity > 0 (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console ‡∏î‡πâ‡∏ß‡∏¢ F12)', 'error');
                    loading.style.display = 'none';
                    return;
                }

                // Send to backend for PAR matching
                const response = await fetch('/api/parse-transfer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items, date: transferDate })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to parse transfer data');
                }

                parsedTransferItems = result.items.map(item => ({
                    ...item,
                    direction: direction,
                    finalQty: direction === 'in' ? item.qty : -item.qty
                }));

                displayTransferItems(parsedTransferItems);
                showMessage('transferMessage', `‚úÖ ‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transfer ${parsedTransferItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');

            } catch (error) {
                console.error('Parse transfer error:', error);
                showMessage('transferMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayTransferItems(items) {
            const container = document.getElementById('transferItemsTable');
            const direction = items[0]?.direction || 'in';
            const directionText = direction === 'in' ? 'üì• ‡πÄ‡∏Ç‡πâ‡∏≤ (+)' : 'üì§ ‡∏≠‡∏≠‡∏Å (-)';
            const directionColor = direction === 'in' ? '#4CAF50' : '#f44336';

            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: ${direction === 'in' ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
                    <strong style="color: ${directionColor};">‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á: ${directionText}</strong>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Original)</th>
                            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">PAR Name (‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö)</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</th>
                            <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Match Score</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            items.forEach((item, index) => {
                const matchColor = item.matchScore >= 0.8 ? '#4CAF50' :
                                 item.matchScore >= 0.6 ? '#FF9800' : '#f44336';

                html += `
                    <tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                        <td style="padding: 10px; border: 1px solid #ddd;">${item.originalName}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <strong>${item.name}</strong>
                            ${item.category ? `<br><small style="color: #666;">${item.category}</small>` : ''}
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${item.qty}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: ${directionColor}; font-weight: bold;">
                            ${item.finalQty > 0 ? '+' : ''}${item.finalQty.toFixed(2)}
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                            <span style="color: ${matchColor}; font-weight: bold;">
                                ${(item.matchScore * 100).toFixed(0)}%
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
            document.getElementById('transferItemsContainer').style.display = 'block';
        }

        async function saveTransferData() {
            const transferDate = document.getElementById('transferDate').value;

            if (!transferDate || parsedTransferItems.length === 0) {
                showMessage('transferMessage', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                return;
            }

            const loading = document.getElementById('transferLoading');
            loading.style.display = 'block';

            try {
                const response = await fetch('/api/save-daily-transfer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: transferDate,
                        items: parsedTransferItems,
                        direction: parsedTransferItems[0].direction
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save transfer data');
                }

                showMessage('transferMessage', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transfer ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

                // Clear form
                document.getElementById('transferPasteData').value = '';
                parsedTransferItems = [];
                document.getElementById('transferItemsContainer').style.display = 'none';

                // Reload dates
                loadTransferDates();

            } catch (error) {
                console.error('Save transfer error:', error);
                showMessage('transferMessage', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadTransferDates() {
            try {
                const response = await fetch('/api/transfer-dates');
                const result = await response.json();

                const select = document.getElementById('viewTransferDate');
                select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà --</option>';

                if (result.dates && result.dates.length > 0) {
                    result.dates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = formatThaiDate(date);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Load transfer dates error:', error);
            }
        }

        async function loadTransferItems() {
            const date = document.getElementById('viewTransferDate').value;
            const loading = document.getElementById('viewTransferLoading');
            const container = document.getElementById('viewTransferTable');

            if (!date) {
                container.innerHTML = '';
                return;
            }

            loading.style.display = 'block';

            try {
                const response = await fetch(`/api/daily-transfer/${date}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load transfer data');
                }

                displayTransferItems(result.items);
                container.innerHTML = document.getElementById('transferItemsTable').innerHTML;

            } catch (error) {
                console.error('Load transfer items error:', error);
                container.innerHTML = `<p style="color: #f44336;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Logout function
        async function logout() {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                return;
            }

            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    window.location.href = '/login.html';
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');
            }
        }

        // Load current user
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (data.isAuthenticated) {
                    document.getElementById('currentUser').textContent = data.username;
                } else {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Load user error:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentUser();
            loadParPeriods();
            loadDailySaleDates();
            loadTransferDates();

            // Set today's date for transfer
            document.getElementById('transferDate').valueAsDate = new Date();
        });
    </script>
</body>
</html>
